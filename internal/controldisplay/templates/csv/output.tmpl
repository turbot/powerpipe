{{ define "output" }}
{{- if render_context.Config.RenderHeader -}}
group_id{{ render_context.Config.Separator }}title{{ render_context.Config.Separator }}description{{ render_context.Config.Separator }}control_id{{ render_context.Config.Separator }}control_title{{ render_context.Config.Separator }}control_description{{ render_context.Config.Separator }}reason{{ render_context.Config.Separator }}resource{{ render_context.Config.Separator }}status{{ render_context.Config.Separator }}severity{{ range .Data.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ . }}{{ end }}{{ range .Data.Root.AllTagKeys }}{{ render_context.Config.Separator }}{{ . }}{{ end }}
{{ end -}}
{{ template "result_group_template" .Data }}
{{- end }}

{{ define "result_group_template" -}}
  {{- range .FlatControlRuns -}}
    {{- template "control_run_template" . -}}
  {{- end }}
{{- end }}

{{ define "control_run_template" -}}
  {{- if .RunErrorString -}}
    {{ template "control_error_template" (dict "Parent" $.Parent "ControlRun" $) -}}
  {{- else -}}
    {{- range .Rows -}}
      {{- template "control_row_template" (dict "Row" . "Parent" $.Parent "ControlRun" $) -}}
    {{- end -}}
  {{- end }}
{{- end }}

{{ define "control_error_template" -}}
  {{- template "group_details" . }}{{ render_context.Config.Separator }}{{ template "control_details" . }}{{ render_context.Config.Separator }}{{ toCsvCell .RunErrorString }}{{ render_context.Config.Separator }}{{ render_context.Config.Separator }}{{ toCsvCell "error" }}{{ render_context.Config.Separator }}{{ template "dimensions" . }}{{ template "tags" . }}{{ println }}
{{- end }}

{{ define "control_row_template" -}}
  {{- template "group_details" . }}{{ render_context.Config.Separator }}{{ template "control_details" . }}{{ render_context.Config.Separator }}{{ template "reason_resource_status" . }}{{ render_context.Config.Separator }}{{ template "control_severity" . }}{{ template "dimensions" . }}{{ template "tags" . }}{{ println }}
{{- end }}

{{ define "group_details" -}}
  {{- with .Parent }}
    {{- toCsvCell .GroupId }}{{ render_context.Config.Separator }}{{ toCsvCell .Title }}{{ render_context.Config.Separator }}{{ toCsvCell .Description -}}
  {{- end }}
{{- end }}

{{ define "control_details" -}}
  {{- with .ControlRun }}
    {{- toCsvCell .ControlId }}{{ render_context.Config.Separator }}{{ toCsvCell .Title }}{{ render_context.Config.Separator }}{{ toCsvCell .Description -}}
  {{- end }}
{{- end }}

{{ define "control_severity" -}}
  {{- with .ControlRun }}
    {{- toCsvCell .Severity -}}
  {{- end }}
{{- end }}

{{ define "reason_resource_status" -}}
  {{- with .Row }}
    {{- toCsvCell .Reason }}{{ render_context.Config.Separator }}{{ toCsvCell .Resource }}{{ render_context.Config.Separator }}{{ toCsvCell .Status -}}
  {{- end }}
{{- end }}

{{ define "dimensions" -}}
  {{- $row := .Row }}
  {{- range $.ControlRun.Tree.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ toCsvCell ($row.GetDimensionValue .) }}{{ end -}}
{{- end }}

{{ define "tags" -}}
  {{- $row := .Row }}
  {{- $tagKeys := $.ControlRun.Tree.Root.AllTagKeys }}
  {{- range $tagKeys }}
    {{- render_context.Config.Separator -}}
    {{- if $row.Run.Tags }}
      {{- with $value := (index $row.Run.Tags .) }}
        {{- toCsvCell $value -}}
      {{- else }}
        {{- toCsvCell "" -}}
      {{- end }}
    {{- else }}
      {{- toCsvCell "" -}}
    {{- end }}
  {{- end -}}
{{- end }}