{{ define "output" }}
{{- if render_context.Config.RenderHeader -}}
group_id{{ render_context.Config.Separator }}title{{ render_context.Config.Separator }}description{{ render_context.Config.Separator }}control_id{{ render_context.Config.Separator }}control_title{{ render_context.Config.Separator }}control_description{{ render_context.Config.Separator }}reason{{ render_context.Config.Separator }}resource{{ render_context.Config.Separator }}status{{ render_context.Config.Separator }}severity{{ range .Data.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ . }}{{ end }}{{ range .Data.Root.AllTagKeys }}{{ render_context.Config.Separator }}{{ . }}{{ end }}
{{ end -}}
{{ template "result_group_template" .Data.Root }}
{{- end }}

{{ define "result_group_template" -}}
  {{- range .ControlRuns -}}
    {{- template "control_run_template" . }}
  {{- end -}}
  {{- range .Groups -}}
    {{- template "result_group_template" . -}}
  {{- end -}}
{{- end }}

{{ define "control_run_template" }}
{{- if .RunErrorString }}{{ range .Rows }}{{ template "control_error_template" . }}{{ end }}
{{ else }}{{ range .Rows }}{{ template "control_row_template" . }}{{ end }}{{ end }}{{ end }}

{{ define "control_error_template" -}}
  {{- $row := . -}}
  {{- $parent := index $row.Run.Parents 0 -}}
  {{ toCsvCell $parent.GroupId }}{{ render_context.Config.Separator }}{{ toCsvCell $parent.Title }}{{ render_context.Config.Separator }}{{ toCsvCell $parent.Description }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.ControlId }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Title }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Description }}{{ render_context.Config.Separator }}{{ toCsvCell .RunErrorString }}{{ render_context.Config.Separator }}{{ render_context.Config.Separator }}error{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Severity }}{{- range $row.Run.Tree.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ toCsvCell ($row.GetDimensionValue .) }}{{ end -}}{{- range $row.Run.Tree.Root.AllTagKeys }}{{ render_context.Config.Separator }}{{ toCsvCell (index $row.Run.Tags .) }}{{ end -}}{{ println }}
{{- end }}

{{ define "control_row_template" -}}
  {{- $row := . -}}
  {{- $parent := index $row.Run.Parents 0 -}}
  {{ toCsvCell $parent.GroupId }}{{ render_context.Config.Separator }}{{ toCsvCell $parent.Title }}{{ render_context.Config.Separator }}{{ toCsvCell $parent.Description }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.ControlId }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Title }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Description }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Reason }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Resource }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Status }}{{ render_context.Config.Separator }}{{ toCsvCell $row.Run.Severity }}{{- range $row.Run.Tree.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ toCsvCell ($row.GetDimensionValue .) }}{{ end -}}{{- range $row.Run.Tree.Root.AllTagKeys }}{{ render_context.Config.Separator }}{{ toCsvCell (index $row.Run.Tags .) }}{{ end -}}{{ println }}
{{- end }}

{{ define "control_details" -}}
  {{ toCsvCell .Run.ControlId }}{{ render_context.Config.Separator }}{{ toCsvCell .Run.Title }}{{ render_context.Config.Separator }}{{ toCsvCell .Run.Description -}}
{{- end }}

{{ define "control_severity" -}}
  {{ toCsvCell .Run.Severity -}}
{{- end }}

{{ define "reason_resource_status" -}}
  {{ toCsvCell .Reason }}{{ render_context.Config.Separator }}{{ toCsvCell .Resource }}{{ render_context.Config.Separator }}{{ toCsvCell .Status -}}
{{- end }}

{{ define "dimensions" -}}
  {{- $row := . -}}
  {{- range .Run.Tree.Root.DimensionKeys }}{{ render_context.Config.Separator }}{{ toCsvCell ($row.GetDimensionValue .) }}{{ end -}}
{{- end }}

{{ define "tags" -}}
  {{- $row := . -}}
  {{- range .Run.Tree.Root.AllTagKeys }}{{ render_context.Config.Separator }}{{ toCsvCell (index $row.Run.Tags .) }}{{ end -}}
{{- end }}
